<!DOCTYPE html>

<html>
<head>
  <title>launchpad.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>launchpad.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">var</span> _ = require(<span class="string">"underscore"</span>);
<span class="keyword">var</span> Backbone = require(<span class="string">"backbone"</span>);
<span class="keyword">var</span> Button = require(<span class="string">"./button"</span>).Button;
<span class="keyword">var</span> LawrenceSans = require(<span class="string">"./lawrencesans"</span>).LawrenceSans;
<span class="keyword">var</span> midi = require(<span class="string">'midi'</span>);

<span class="comment">/*
 * Launchpad
 * Represents the launchpad as a whole
 */</span>
<span class="keyword">var</span> Launchpad = <span class="function"><span class="keyword">function</span><span class="params">(port, initAnimation)</span> {</span>
    <span class="keyword">if</span> (initAnimation === <span class="literal">undefined</span>) initAnimation = <span class="literal">true</span>;
    <span class="keyword">var</span> name = <span class="number">0</span>;
    <span class="keyword">var</span> row = <span class="number">0</span>;
    <span class="keyword">var</span> column = <span class="number">0</span>;
    <span class="keyword">this</span>.name = name;

    <span class="keyword">this</span>.row = row;
    <span class="keyword">this</span>.column = column;

    _.extend(<span class="keyword">this</span>, Backbone.Events);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Some variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">this</span>._grid = [];
    <span class="keyword">var</span> that = <span class="keyword">this</span>;


    <span class="keyword">this</span>.specials = {
        <span class="number">0</span>:{ <span class="number">8</span>: [<span class="string">"right"</span>,<span class="string">"vol"</span>] },
        <span class="number">1</span>:{ <span class="number">8</span>: [<span class="string">"right"</span>,<span class="string">"pan"</span>] },
        <span class="number">2</span>:{ <span class="number">8</span>: [<span class="string">"right"</span>,<span class="string">"snd A"</span>] },
        <span class="number">3</span>:{ <span class="number">8</span>: [<span class="string">"right"</span>,<span class="string">"snd B"</span>] },
        <span class="number">4</span>:{ <span class="number">8</span>: [<span class="string">"right"</span>,<span class="string">"stop"</span>] },
        <span class="number">5</span>:{ <span class="number">8</span>: [<span class="string">"right"</span>,<span class="string">"trk on"</span>] },
        <span class="number">6</span>:{ <span class="number">8</span>: [<span class="string">"right"</span>,<span class="string">"solo"</span>] },
        <span class="number">7</span>:{ <span class="number">8</span>: [<span class="string">"right"</span>,<span class="string">"arm"</span>] },
        <span class="number">8</span>:{
            <span class="number">0</span>:[<span class="string">"up"</span>,<span class="string">"page"</span>],
            <span class="number">1</span>:[<span class="string">"down"</span>,<span class="string">"page"</span>],
            <span class="number">2</span>:[<span class="string">"left"</span>,<span class="string">"page"</span>],
            <span class="number">3</span>:[<span class="string">"right"</span>,<span class="string">"page"</span>],
            <span class="number">4</span>:[<span class="string">"session"</span>,<span class="string">"inst"</span>],
            <span class="number">5</span>:[<span class="string">"user 1"</span>,<span class="string">"fx"</span>],
            <span class="number">6</span>:[<span class="string">"user 2"</span>,<span class="string">"user"</span>],
            <span class="number">7</span>:[<span class="string">"mixer"</span>,<span class="string">"mixer"</span>],
            <span class="number">8</span>:<span class="literal">null</span>
        }
    };

    <span class="keyword">this</span>.createButtons = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Initialize all of the buttons</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span>(<span class="keyword">var</span> y = <span class="number">0</span>; y &lt; <span class="number">9</span>; y++) {
            <span class="keyword">for</span>(<span class="keyword">var</span> x = <span class="number">0</span>; x &lt; <span class="number">9</span>; x++) {
                <span class="keyword">if</span> (that._grid[x] === <span class="literal">undefined</span>) that._grid[x] = [];
                that._grid[x][y] = <span class="keyword">new</span> Button(that, x, y);
                (<span class="function"><span class="keyword">function</span><span class="params">(x,y)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>that._grid[x][y].dark();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                })(x,y);

            }
        }
    };

    

    <span class="comment">/*
     * Gets a button object from this._grid
     */</span>
    <span class="keyword">this</span>.getButton = <span class="function"><span class="keyword">function</span><span class="params">(x, y)</span> {</span>
        <span class="keyword">if</span> (y === <span class="literal">undefined</span>) {
            y = Math.floor(x/<span class="number">16</span>);
            x = x % <span class="number">16</span>;
        }

        <span class="keyword">if</span> (<span class="keyword">this</span>._grid[x] === <span class="literal">undefined</span> || <span class="keyword">this</span>._grid[x][y] === <span class="literal">undefined</span>) {
            <span class="keyword">return</span> <span class="literal">undefined</span>;
        }

        <span class="keyword">if</span>(y !== <span class="literal">undefined</span>)
            <span class="keyword">return</span> <span class="keyword">this</span>._grid[x][y];

        <span class="keyword">var</span> map = mapButtonToLaunchpad(x);
        <span class="keyword">return</span> <span class="keyword">this</span>._grid[map[<span class="number">0</span>]][map[<span class="number">1</span>]];
    };

    <span class="comment">/*
     * Turns all LEDs off
     */</span>
    <span class="keyword">this</span>.allDark = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Reset the state on all buttons</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span>(<span class="keyword">var</span> x = <span class="number">0</span>; x &lt; <span class="number">9</span>; x++) {
            <span class="keyword">for</span>(<span class="keyword">var</span> y = <span class="number">0</span>; y &lt; <span class="number">9</span>; y++) {
                <span class="keyword">this</span>._grid[x][y].dark();
            }
        }
    };

    <span class="keyword">this</span>.clear = <span class="keyword">this</span>.allDark;

    <span class="comment">/*
     * Turns all LEDs on
     */</span>
    <span class="keyword">this</span>.allLight = <span class="function"><span class="keyword">function</span><span class="params">(color)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Reset the state on all buttons</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">for</span>(<span class="keyword">var</span> x = <span class="number">0</span>; x &lt; <span class="number">9</span>; x++) {
            <span class="keyword">for</span>(<span class="keyword">var</span> y = <span class="number">0</span>; y &lt; <span class="number">9</span>; y++) {
                <span class="keyword">this</span>._grid[x][y].light(color);
            }
        }
    };

    <span class="comment">/*
     * Event handler for button press
     */</span>
    <span class="keyword">this</span>.receiveMessage = <span class="function"><span class="keyword">function</span><span class="params">(deltaTime, msg)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>We have to do something special for the top buttons</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> button = that.getButton(msg[<span class="number">1</span>]);
        <span class="keyword">if</span>(msg[<span class="number">0</span>] == <span class="string">"176"</span>)
            button = that.getButton(parseInt(msg[<span class="number">1</span>],<span class="number">10</span>) % <span class="number">8</span>, <span class="number">8</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>On or off?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> state = (parseInt(msg[<span class="number">2</span>], <span class="number">10</span>) == <span class="number">127</span>) ? <span class="literal">true</span> : <span class="literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Emit an event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span>(state) {
            button.trigger(<span class="string">"press"</span>,deltaTime);
            button.trigger(<span class="string">"state_change"</span>);
            <span class="keyword">this</span>.trigger(<span class="string">"press"</span>, button);
            <span class="keyword">if</span> (button.special !== <span class="literal">false</span>) <span class="keyword">this</span>.trigger(<span class="string">"special_press"</span>, button);

        } <span class="keyword">else</span> {
            button.trigger(<span class="string">"release"</span>,deltaTime);
            button.trigger(<span class="string">"state_change"</span>);
            that.trigger(<span class="string">"release"</span>, button);
            <span class="keyword">if</span> (button.special !== <span class="literal">false</span>) that.trigger(<span class="string">"special_release"</span>, button);
        }
    };

    <span class="keyword">this</span>.randomColor = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> options = [<span class="number">3</span>, <span class="number">48</span>, <span class="number">18</span>, <span class="number">49</span>];
        <span class="keyword">var</span> rand = Math.floor(Math.random() * options.length);
        <span class="keyword">return</span> options[rand];
    };

    <span class="keyword">this</span>.initialize = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">if</span> (!initAnimation) {</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>console.log(&quot;hi&quot;);
that.clear();</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                that.trigger(<span class="string">"ready"</span>, that);
                that.ready = <span class="literal">true</span>;
            },<span class="number">0</span>);
            <span class="keyword">return</span>;
        }


        <span class="keyword">var</span> colors = [
            <span class="number">3</span>, <span class="number">48</span>, <span class="number">18</span>, <span class="number">49</span>, <span class="number">0</span>
        ];
        
        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; colors.length;j++) {
            <span class="keyword">var</span> i = colors[j];
            (<span class="function"><span class="keyword">function</span><span class="params">(i)</span>{</span>
                setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                    <span class="keyword">for</span>(<span class="keyword">var</span> x = <span class="number">0</span>; x &lt; <span class="number">9</span>; x++) {
                        <span class="keyword">for</span>(<span class="keyword">var</span> y = <span class="number">0</span>; y &lt; <span class="number">9</span>; y++) {
                            (<span class="function"><span class="keyword">function</span><span class="params">(x,y)</span>{</span>
                                <span class="keyword">var</span> t = setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                                    <span class="keyword">try</span> {
                                        that._grid[x][y].light(i);
                                        <span class="keyword">if</span> (i === <span class="number">0</span> &amp;&amp; x === <span class="number">8</span> &amp;&amp; y === <span class="number">8</span>) {
                                            that.trigger(<span class="string">"ready"</span>, that);
                                            that.ready = <span class="literal">true</span>;
                                        }
                                    }
                                    <span class="keyword">catch</span> (e) {
                                        console.log(x+<span class="string">" "</span>+y);
                                    }
                                },(x+y)*<span class="number">100</span>);
                            })(x,y);
                        }
                    }
                }, <span class="number">500</span> * j);
            })(i);
        }
    };


    <span class="keyword">this</span>.ready = <span class="literal">false</span>;
    <span class="keyword">this</span>.init = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Set up a new output.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.output = <span class="keyword">new</span> midi.output();</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Set up a new input.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.input = <span class="keyword">new</span> midi.input();

        <span class="keyword">this</span>.createButtons();</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Open the first available output port.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.output.openPort(port);
        <span class="keyword">this</span>.input.openPort(port);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Configure a callback.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">this</span>.input.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span><span class="params">(deltaTime, message)</span> {</span>
            that.receiveMessage(deltaTime, message);
        });

        console.log(<span class="string">"running launchpad: "</span>+<span class="keyword">this</span>.output.getPortName(port));

        <span class="keyword">this</span>.initialize();
    };

    console.log(<span class="string">"setting up Launchpad on port:"</span>+port);
    <span class="keyword">this</span>.init();
    
};



Launchpad.prototype.renderBytes = <span class="function"><span class="keyword">function</span><span class="params">(bytes, color)</span> {</span>
    <span class="keyword">if</span> (bytes === <span class="literal">undefined</span>) <span class="keyword">return</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> x = <span class="number">0</span>; x &lt; bytes.length; x++) {
        <span class="keyword">var</span> byt = bytes[x];
        <span class="keyword">for</span> (<span class="keyword">var</span> y = <span class="number">0</span>; y &lt; byt.length; y++) {
            <span class="keyword">if</span> (!<span class="keyword">this</span>._grid[y][x]) {
                console.log(<span class="string">"Button not found: x:"</span>+x+<span class="string">", y:"</span>+y);
                <span class="keyword">return</span>;
            }
            byt[y] = byt[y].toLowerCase();
            <span class="keyword">switch</span> (byt[y]) {
                <span class="keyword">case</span> <span class="string">"1"</span>:
                    <span class="keyword">this</span>._grid[y][x].light(color);
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">"r"</span>:
                    <span class="keyword">this</span>._grid[y][x].light(exports.colors.red.high);
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">"o"</span>:
                    <span class="keyword">this</span>._grid[y][x].light(exports.colors.orange.high);
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">"y"</span>:
                    <span class="keyword">this</span>._grid[y][x].light(exports.colors.yellow.high);
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">"g"</span>:
                    <span class="keyword">this</span>._grid[y][x].light(exports.colors.green.high);
                    <span class="keyword">break</span>;
                <span class="keyword">case</span> <span class="string">"0"</span>:
                    <span class="keyword">this</span>._grid[y][x].light(exports.colors.off);
                    <span class="keyword">break</span>;
            }
        }
    }
};

Launchpad.prototype.displayCharacter = <span class="function"><span class="keyword">function</span><span class="params">(letter, color)</span> {</span>
  <span class="keyword">var</span> bytes = LawrenceSans(letter);
  <span class="keyword">this</span>.renderBytes(bytes, color);
};

Launchpad.prototype.displayString = <span class="function"><span class="keyword">function</span><span class="params">(str, delay, callback, color)</span> {</span>
  <span class="keyword">if</span> (delay === <span class="literal">undefined</span>) delay = <span class="number">500</span>;
  <span class="keyword">var</span> that = <span class="keyword">this</span>;
  <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; str.length; j++) {
    (<span class="function"><span class="keyword">function</span><span class="params">(j)</span>{</span>
      setTimeout(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        that.displayCharacter(str[j], color);
        <span class="keyword">if</span> (j+<span class="number">1</span> === str.length &amp;&amp; callback !== <span class="literal">undefined</span>) setTimeout(callback, delay);
      }, j*delay);
    })(j);
  }
};

Launchpad.prototype.scrollString = <span class="function"><span class="keyword">function</span><span class="params">(str,delay, color, onFinished)</span> {</span>
    <span class="keyword">var</span> bytes = [];
    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.length; i++) {
        bytes.push(LawrenceSans(str[i]));
        bytes.push([<span class="string">"0"</span>,<span class="string">"0"</span>,<span class="string">"0"</span>,<span class="string">"0"</span>,<span class="string">"0"</span>,<span class="string">"0"</span>,<span class="string">"0"</span>,<span class="string">"0"</span>]);
    }
    <span class="keyword">this</span>.scrollBytes(bytes, delay, color, onFinished);
}

Launchpad.prototype.colorize = <span class="function"><span class="keyword">function</span><span class="params">(bytes, colorStr, nullColorStr)</span> {</span>
    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; i++) {
        <span class="keyword">var</span> str = <span class="string">""</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; bytes[i].length; j++) {
            <span class="keyword">if</span> (bytes[i][j] === <span class="string">"1"</span>) str += colorStr;
            <span class="keyword">else</span>  str += nullColorStr;
        }
        bytes[i] = str;
    }
    <span class="keyword">return</span> bytes;
}

Launchpad.prototype.clearScroll = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
    clearInterval(<span class="keyword">this</span>.scrollInterval);
}

Launchpad.prototype.scrollBytes = <span class="function"><span class="keyword">function</span><span class="params">(bytes, delay, color, onFinished)</span> {</span>
    <span class="keyword">var</span> perScreen = <span class="number">8</span>;
    <span class="keyword">var</span> charPos = <span class="number">0</span>;
    <span class="keyword">var</span> overallBytes = [];
    <span class="keyword">for</span> (<span class="keyword">var</span> i= <span class="number">0</span>; i &lt; bytes[<span class="number">0</span>].length; i++) {
        <span class="keyword">var</span> toAdd = <span class="string">""</span>;
        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; bytes.length;j++) {
            toAdd += bytes[j][i];
        }
        overallBytes.push(toAdd);
    }

    <span class="keyword">this</span>.scrollInterval;
    <span class="keyword">var</span> that = <span class="keyword">this</span>;

    <span class="keyword">if</span> (delay === <span class="literal">undefined</span>) delay = <span class="number">200</span>;

    <span class="keyword">var</span> visibleSet = <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> toReturn = [];
        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; overallBytes.length; i++) {
            toReturn[i] = <span class="keyword">new</span> Array(perScreen);
            <span class="keyword">var</span> str = <span class="string">""</span>;
            <span class="keyword">for</span> (<span class="keyword">var</span> j = charPos; j &lt; charPos+perScreen; j++) {
                <span class="keyword">if</span> (overallBytes[i][j] !== <span class="literal">undefined</span>)
                    str += overallBytes[i][j];
                <span class="keyword">else</span> {
                    clearInterval(interval);
                    <span class="keyword">return</span>;
                }
            }
            toReturn[i] = str;
        }
        charPos++;
        <span class="keyword">return</span> toReturn;
    };

    interval = setInterval(<span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
        <span class="keyword">var</span> set = visibleSet();
        <span class="keyword">if</span> (set === <span class="literal">undefined</span> &amp;&amp; <span class="keyword">typeof</span> onFinished == <span class="string">"function"</span>) onFinished();
        <span class="keyword">else</span>
            that.renderBytes(set, color);
    }, delay);

};



exports.colors = Launchpad.prototype.colors = {
    off: <span class="number">0</span>,
    red: {
        low: <span class="number">1</span>,
        medium:<span class="number">2</span>,
        high:<span class="number">3</span>
    },
    yellow: {
        low: <span class="number">17</span>,
        medium:<span class="number">34</span>,
        high:<span class="number">54</span>
    },
    orange: {
        low: <span class="number">45</span>,
        medium:<span class="number">46</span>,
        high:<span class="number">23</span>
    },
    green: {
        low: <span class="number">16</span>,
        medium:<span class="number">32</span>,
        high:<span class="number">48</span>
    }
};

exports.Launchpad = Launchpad;

exports.connect = <span class="function"><span class="keyword">function</span><span class="params">(port, initAnimation)</span> {</span>
    <span class="keyword">return</span> <span class="keyword">new</span> Launchpad(port, initAnimation);
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
